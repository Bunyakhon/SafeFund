<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>SafeFund - ประวัติการชำระเงิน</title>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200..800&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" href="/css/style.css">
</head>

<body>
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    <aside>
        <div class="branding">
            <div class="logo-icon"><span class="material-symbols-outlined">shield_person</span></div>
            <div class="brand-text">
                <h1>SafeFund</h1>
                <p>Village Mgmt</p>
            </div>
        </div>
        <nav>
            <a class="nav-item" href="#"><span class="material-symbols-outlined">dashboard</span> Dashboard</a>
            <a class="nav-item" href="/"><span class="material-symbols-outlined">group</span> จัดการสมาชิก</a>
            <a class="nav-item active" href="/loans"><span
                    class="material-symbols-outlined">account_balance_wallet</span> จัดการเงินกู้</a>
            <a class="nav-item" href="/savings"><span class="material-symbols-outlined">savings</span> เงินฝากสัจจะ</a>
            <a class="nav-item" href="#"><span class="material-symbols-outlined">assessment</span> รายงาน</a>
        </nav>
    </aside>

    <div class="main-wrapper">
        <header>
            <div class="header-left">
                <button class="mobile-menu-btn" id="mobileMenuBtn"><span
                        class="material-symbols-outlined">menu</span></button>
                <h2>ระบบจัดการกองทุนหมู่บ้าน</h2>
            </div>
            <div class="header-actions">
                <button class="icon-btn" id="darkModeBtn" title="สลับโหมดมืด/สว่าง">
                    <span class="material-symbols-outlined" id="darkModeIcon">dark_mode</span>
                </button>
            </div>
        </header>

        <main>
            <div class="page-header">
                <div class="page-title">
                    <h1>ประวัติและตารางการชำระเงิน</h1>
                    <p>รหัสสัญญา: LN-<%= loan.loan_id %> | ผู้กู้: <%= loan.Member.member_name %>
                    </p>
                </div>
                <button class="btn-danger" onclick="window.location.href='/loans'">
                    <span class="material-symbols-outlined">arrow_back</span> ย้อนกลับ
                </button>
            </div>

            <div class="stats-grid"
                style="margin-bottom: 24px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                <div class="stat-card">
                    <div class="stat-info">
                        <p>สถานะสัญญา</p>
                        <p style="font-size: 1.25rem; font-weight: 800;">
                            <%= loan.status %>
                        </p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-info">
                        <p>ยอดเงินกู้สุทธิ</p>
                        <p style="font-size: 1.25rem; font-weight: 800; color: var(--primary);">
                            ฿ <%= parseFloat(loan.loan_amount).toLocaleString() %>
                        </p>
                    </div>
                </div>

                <% let totalToPay=0; let totalPaid=0; if (loan.payments && loan.payments.length> 0) {
                    totalToPay = loan.payments.reduce((acc, p) => acc + parseFloat(p.amount), 0);
                    totalPaid = loan.payments.filter(p => p.status === 'Paid').reduce((acc, p) => acc +
                    parseFloat(p.amount), 0);
                    }
                    let remaining = totalToPay - totalPaid;
                    %>

                    <div class="stat-card">
                        <div class="stat-info">
                            <p>ชำระไปแล้ว</p>
                            <p style="font-size: 1.25rem; font-weight: 800; color: #28a745;">
                                ฿ <%= totalPaid.toLocaleString(undefined, {minimumFractionDigits: 2,
                                    maximumFractionDigits: 2}) %>
                            </p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-info">
                            <p>ยอดคงเหลือ (รวมดอกเบี้ย)</p>
                            <p style="font-size: 1.25rem; font-weight: 800; color: #dc3545;">
                                ฿ <%= remaining.toLocaleString(undefined, {minimumFractionDigits: 2,
                                    maximumFractionDigits: 2}) %>
                            </p>
                        </div>
                    </div>
            </div>

            <div class="content-card">
                <div class="form-header-icon">
                    <div class="icon-circle"><span class="material-symbols-outlined">calendar_month</span></div>
                    <h2 style="font-size: 1.25rem; font-weight: 700;">ตารางการผ่อนชำระรายงวด</h2>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>งวดที่</th>
                                <th>วันที่กำหนดชำระ</th>
                                <th>ยอดที่ต้องชำระ</th>
                                <th>สถานะ</th>
                                <th style="text-align: right;">จัดการ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% if (loan.payments && loan.payments.length> 0) { %>
                                <% loan.payments.forEach(function(pay) { %>
                                    <tr>
                                        <td>งวดที่ <%= pay.period %>
                                        </td>
                                        <td>
                                            <%= pay.payment_date %>
                                        </td>
                                        <td style="font-weight: 700;">฿ <%= parseFloat(pay.amount).toLocaleString() %>
                                        </td>
                                        <td>
                                            <span
                                                class="status-badge <%= pay.status === 'Paid' ? 'status-normal' : 'status-pending' %>">
                                                <%= pay.status==='Paid' ? 'ชำระแล้ว' : 'ค้างชำระ' %>
                                            </span>
                                        </td>
                                        <td style="text-align: right;">
                                            <% if (pay.status !=='Paid' ) { %>
                                                <a href="/confirm-payment/<%= pay.payment_id %>/<%= loan.loan_id %>"
                                                    onclick="return confirm('คุณยืนยันว่าได้รับเงินงวดที่ <%= pay.period %> เรียบร้อยแล้วใช่หรือไม่?');">
                                                    <button class="btn-info"
                                                        style="padding: 4px 12px; font-size: 0.8rem; cursor: pointer;">
                                                        ยืนยันการชำระ
                                                    </button>
                                                </a>
                                                <% } else { %>
                                                    <div
                                                        style="display: flex; align-items: center; justify-content: flex-end; color: var(--success); gap: 4px;">
                                                        <span
                                                            style="font-size: 0.85rem; font-weight: 600;">ชำระแล้ว</span>
                                                        <span class="material-symbols-outlined"
                                                            style="font-size: 20px;">check_circle</span>
                                                    </div>
                                                    <% } %>
                                        </td>
                                    </tr>
                                    <% }); %>
                                        <% } else { %>
                                            <tr>
                                                <td colspan="5"
                                                    style="text-align: center; padding: 40px; color: var(--text-muted);">
                                                    ไม่พบตารางการผ่อนชำระ</td>
                                            </tr>
                                            <% } %>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>
    <script src="/js/member-management.js"></script>
</body>

</html>